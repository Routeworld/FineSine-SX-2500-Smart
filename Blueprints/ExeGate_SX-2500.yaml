blueprint:
  name: –£–º–Ω—ã–π –ò–ë–ü ExeGate SX-2500 (ESP32) ‚Äî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è + –ë–µ—Å—à–æ–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  description: >
    –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è RouteMedia ‚ù§Ô∏è
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å debounce: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏, –ø–∞–¥–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∞ –ø–æ —à–∞–≥–∞–º,
    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ç—å –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ.
  domain: automation
  input:
    battery_percent:
      name: –°–µ–Ω—Å–æ—Ä –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∑–∞—Ä—è–¥–∞ –ê–ö–ë
      selector:
        entity:
          domain: sensor
    battery_voltage:
      name: –°–µ–Ω—Å–æ—Ä –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –ê–ö–ë
      selector:
        entity:
          domain: sensor
    mains_online:
      name: –°–µ–Ω—Å–æ—Ä ¬´–°–µ—Ç—å –æ–Ω–ª–∞–π–Ω¬ª (binary_sensor)
      selector:
        entity:
          domain: binary_sensor
    contactor_switch:
      name: –ö–æ–Ω—Ç–∞–∫—Ç–æ—Ä / —Ä–µ–ª–µ –Ω–∞ –≤—Ö–æ–¥–µ 220–í (–¥–ª—è –∞–≤—Ç–æ-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)
      selector:
        entity:
          domain: switch
    low_battery_threshold:
      name: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞ (%)
      default: 25
      selector:
        number:
          min: 10
          max: 40
          step: 5
    report_interval:
      name: –®–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ –∑–∞—Ä—è–¥—É (%)
      default: 10
      selector:
        number:
          min: 5
          max: 25
          step: 5
    debounce_seconds:
      name: Debounce (—Å–µ–∫—É–Ω–¥—ã)
      default: 15
      selector:
        number:
          min: 5
          max: 60
          step: 1
    notify_device:
      name: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      selector:
        device:
          filter:
            integration: mobile_app
    high_priority:
      name: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      default: true
      selector:
        boolean:
    message_prefix:
      name: –ü—Ä–µ—Ñ–∏–∫—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      default: "üõ°Ô∏è –ò–ë–ü:"
      selector:
        text:

variables:
  battery_percent: !input battery_percent
  battery_voltage: !input battery_voltage
  mains_online: !input mains_online
  contactor: !input contactor_switch
  low_threshold: !input low_battery_threshold
  report_interval: !input report_interval
  debounce: !input debounce_seconds
  prefix: !input message_prefix
  high_prio: !input high_priority
  current_charge: "{{ states(battery_percent) | int(100) }}"
  charge_mod: "{{ current_charge % report_interval }}"

trigger:
  - platform: state
    entity_id: !input battery_percent
    id: battery_change
    for:
      seconds: !input debounce_seconds
  - platform: state
    entity_id: !input mains_online
    id: status_change
    for:
      seconds: !input debounce_seconds

condition:
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id == 'status_change' }}"
      - condition: template
        value_template: >
          {{ trigger.id == 'battery_change'
             and current_charge < 100
             and charge_mod == 0 }}

action:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ç—å –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ
  - choose:
      - conditions:
          - condition: numeric_state
            entity_id: !input battery_percent
            below: !input low_battery_threshold
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input contactor_switch

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - variables:
      notify_message: >
        {% if trigger.id == 'battery_change' %}
          {{ prefix }} –ë–∞—Ç–∞—Ä–µ—è {{ current_charge }}% ‚Ä¢ {{ states(battery_voltage) }} –í
        {% else %}
          {{ prefix }} –°–µ—Ç—å {{ '‚úÖ –û–Ω–ª–∞–π–Ω' if is_state(mains_online, 'on') else '‚ö° –ù–∞ –±–∞—Ç–∞—Ä–µ–µ' }}
        {% endif %}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ high_prio }}"
        sequence:
          - service: notify.mobile_app_{{ device_id }}
            data:
              message: "{{ notify_message }}"
              data:
                priority: high
                ttl: 0
    default:
      - service: notify.mobile_app_{{ device_id }}
        data:
          message: "{{ notify_message }}"

mode: queued
max: 10
